name: Run E2E Tests (Windows)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  e2e:
    runs-on: windows-latest

    steps:
      # 1. Checkout .NET App (Repo A)
      - name: Checkout App Repo
        uses: actions/checkout@v4

      # 2. Checkout Selenium Test Repo
      - name: Checkout Selenium Test Repo
        uses: actions/checkout@v4
        with:
          repository: AbdulQader496/bpTestSelenium
          path: selenium-tests

      # 3. Setup .NET 9
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      # 4. Restore & Build API
      - name: Restore & Build API
        run: |
          dotnet restore
          dotnet build --configuration Release

      # 5. Start the API on localhost:5000
      - name: Start API
        run: |
          Write-Host "Starting API..."
          Start-Process powershell `
            -ArgumentList "-Command dotnet run --project bp/WebApi --urls http://localhost:5000" `
            -NoNewWindow
          Start-Sleep -Seconds 5

      # 6. Wait for API readiness
      - name: Wait for API
        run: |
          $url = "http://localhost:5000"
          Write-Host "Checking if API is ready..."
          for ($i = 1; $i -le 30; $i++) {
              try {
                  Invoke-WebRequest -Uri $url -UseBasicParsing -TimeoutSec 1
                  Write-Host "API is UP!"
                  break
              } catch {
                  Write-Host "API not ready yet... attempt $i"
                  Start-Sleep -Seconds 2
              }
          }

      # 7. Setup Java for Selenium
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      # 8. Setup Chrome
      - name: Setup Chrome
        uses: browser-actions/setup-chrome@v1

      # 9. Run Selenium Tests
      - name: Run Selenium Tests
        working-directory: selenium-tests
        run: mvn -B test

      # 10. Upload Test Reports
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        with:
          name: selenium-test-results
          path: selenium-tests/target/surefire-reports

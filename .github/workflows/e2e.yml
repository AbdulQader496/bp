name: E2E Tests

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master
  pull_request:

jobs:
  e2e:
    runs-on: windows-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Build API
        run: |
          dotnet restore "BPCalculator/BPCalculator.csproj"
          dotnet build "BPCalculator/BPCalculator.csproj" --configuration Release

      - name: Start API
        run: |
          Start-Process -NoNewWindow -FilePath "dotnet" -ArgumentList "run --project BPCalculator/BPCalculator.csproj --urls http://localhost:5000"

      - name: Wait for API
        run: |
          for ($i=1; $i -le 40; $i++) {
            try {
              Invoke-WebRequest "http://localhost:5000" -UseBasicParsing
              Write-Host "API is running!"
              break
            } catch {
              Write-Host "Waiting for API... ($i/40)"
              Start-Sleep -Seconds 3
            }
          }

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      - name: Install Chrome
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://dl.google.com/chrome/install/GoogleChromeStandaloneEnterprise64.msi" -OutFile chrome.msi
          Start-Process msiexec.exe -ArgumentList "/i chrome.msi /qn /norestart" -Wait

      # FIXED CHROME DRIVER INSTALLER
      - name: Install ChromeDriver (auto)
        shell: pwsh
        run: |
          $chromePath = "C:\Program Files\Google\Chrome\Application\chrome.exe"
          $version = (Get-Item $chromePath).VersionInfo.FileVersion
          Write-Host "Chrome version detected: $version"

          $major = $version.Split(".")[0]
          Write-Host "Major version: $major"

          $json = Invoke-RestMethod "https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-with-downloads.json"

          $matched = $json.channels.Stable.downloads.chromedriver | Where-Object { $_.url -like "*win64*" }
          $driverUrl = $matched.url

          Write-Host "Downloading ChromeDriver from: $driverUrl"

          Invoke-WebRequest $driverUrl -OutFile "driver.zip"
          Expand-Archive driver.zip -DestinationPath "C:\ChromeDriver" -Force
          echo "C:\ChromeDriver" | Out-File -Append -Encoding utf8 $env:GITHUB_PATH

      - name: Run Selenium tests
        working-directory: selenium-tests
        run: mvn clean test

      - name: Upload Test Reports
        uses: actions/upload-artifact@v4
        with:
          name: selenium-reports
          path: selenium-tests/target/surefire-reports

name: E2E Tests

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  e2e-tests:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup .NET 9
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 9.0.x

    - name: Install Chrome
      uses: browser-actions/setup-chrome@v1

    - name: Install ChromeDriver matching Chrome
      run: |
        $chromeVersion = (chrome --version).Split(" ")[2]
        echo "Chrome version: $chromeVersion"
        
        Invoke-WebRequest `
          -Uri "https://msedgedriver.azureedge.net/LATEST_RELEASE_$chromeVersion" `
          -OutFile latest.txt

        $driverVersion = Get-Content latest.txt

        echo "Installing ChromeDriver version: $driverVersion"

        Invoke-WebRequest `
          -Uri "https://msedgedriver.azureedge.net/$driverVersion/chromedriver_win32.zip" `
          -OutFile driver.zip
        
        Expand-Archive driver.zip -DestinationPath "C:\Tools\ChromeDriver"
        echo "C:\Tools\ChromeDriver" | Out-File -FilePath $env:GITHUB_PATH -Append

    - name: Print Chrome & ChromeDriver versions
      run: |
        chrome --version
        chromedriver --version

    - name: Restore Dependencies
      run: dotnet restore

    - name: Build API
      run: dotnet build BPCalculator/BPCalculator.csproj --configuration Release

    - name: Start API in background
      run: |
        Start-Process -NoNewWindow `
          dotnet `
          -ArgumentList "run --project BPCalculator/BPCalculator.csproj --urls http://localhost:5000"

    - name: Wait for API to start
      run: |
        echo "Waiting for http://localhost:5000 ..."
        for ($i = 1; $i -le 40; $i++) {
            try {
                $result = Invoke-WebRequest -Uri "http://localhost:5000" -UseBasicParsing -TimeoutSec 2
                echo "API is UP!"
                break
            } catch {
                echo "API not ready yet... ($i/40)"
                Start-Sleep -Seconds 2
            }
        }

    - name: Run Selenium Tests
      run: mvn -f selenium-tests/pom.xml clean test

name: API + Selenium E2E Tests (Windows)

on:
  workflow_dispatch:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  e2e-tests:
    runs-on: windows-latest

    steps:

      # -----------------------------
      # 1. Checkout repo
      # -----------------------------
      - name: Checkout Repo
        uses: actions/checkout@v3

      # -----------------------------
      # 2. Setup Java
      # -----------------------------
      - name: Setup Java 21
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'

      # -----------------------------
      # 3. Setup .NET SDK (to start API)
      # -----------------------------
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '9.0.x'

      # -----------------------------
      # 4. Install Chrome
      # -----------------------------
      - name: Install Chrome
        run: choco install googlechrome --ignore-checksums -y
        shell: powershell

      # -----------------------------
      # 5. Start API
      # -----------------------------
      - name: Start API on port 5000
        working-directory: BPCalculator
        run: |
          Start-Process dotnet -ArgumentList "run --urls http://localhost:5000" -NoNewWindow
        shell: powershell

      # -----------------------------
      # 6. Wait for API
      # -----------------------------
      - name: Wait for API
        run: |
          Write-Host "Waiting for API..."
          for ($i = 0; $i -lt 30; $i++) {
            try {
              $res = Invoke-WebRequest -Uri "http://localhost:5000" -UseBasicParsing -TimeoutSec 3
              if ($res.StatusCode -eq 200) {
                Write-Host "API is UP!"
                break
              }
            } catch { }
            Start-Sleep -Seconds 2
          }
        shell: powershell

      # -----------------------------
      # 7. Run Selenium Tests
      # -----------------------------
      - name: Run Maven Selenium Tests
        working-directory: BpTestSelenium   # FIXED PATH
        run: mvn clean test -e -X
        shell: powershell

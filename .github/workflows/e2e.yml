name: Selenium E2E Tests

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  e2e:
    runs-on: windows-latest

    steps:
    - name: Checkout Main Repo (.NET App)
      uses: actions/checkout@v4

    - name: Setup .NET 9
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 9.0.x

    # ==== BUILD API ====
    - name: Restore API
      run: dotnet restore ./BPCalculator/BPCalculator.csproj

    - name: Build API
      run: dotnet build ./BPCalculator/BPCalculator.csproj --configuration Release

    # ==== RUN API ON localhost:5000 ====
    - name: Start API
      shell: pwsh
      run: |
        Write-Host "Starting API on http://localhost:5000"
        Start-Process -FilePath "dotnet" -ArgumentList "run --project ./BPCalculator/BPCalculator.csproj --urls=http://localhost:5000" -WindowStyle Hidden
        Start-Sleep -Seconds 10

    - name: Verify API is Running
      shell: pwsh
      run: |
        Write-Host "Checking API at http://localhost:5000 ..."
        $response = Invoke-WebRequest -Uri "http://localhost:5000" -UseBasicParsing
        Write-Host "API responded successfully!"
        Write-Host $response.StatusCode

    # ==== INSTALL CHROME ====
    - name: Install Google Chrome
      uses: browser-actions/setup-chrome@v1
      with:
        chrome-version: latest

    - name: Check Chrome Version
      shell: pwsh
      run: chrome --version

    # ==== INSTALL MATCHING CHROME DRIVER ====
    - name: Install ChromeDriver (Auto-Matched)
      uses: nanasess/setup-chromedriver@v2

    - name: Check ChromeDriver Version
      shell: pwsh
      run: chromedriver --version

    # ==== CLONE SELENIUM TESTS ====
    - name: Clone Selenium Repo
      uses: actions/checkout@v4
      with:
        repository: AbdulQader496/bpTestSelenium
        path: selenium-tests

    # ==== RUN SELENIUM TESTS ====
    - name: Run Maven Tests
      shell: pwsh
      working-directory: ./selenium-tests
      run: mvn test -Dmaven.test.failure.ignore=false


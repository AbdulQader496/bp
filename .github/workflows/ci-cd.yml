name: CI-CD pipeline with Tests, Security & Blue-Green

on:
  push:
    branches:
      - dev
      - master
  workflow_dispatch:

env:
  APP_NAME: bp-ca1
  RESOURCE_GROUP: bp-ca1
  STAGING_SLOT_NAME: staging
  PROD_URL: https://bp-ca1-fagtb8cbeaaue7cq.spaincentral-01.azurewebsites.net/
  STAGING_URL: https://bp-ca1-staging-f5axbmhyhrcahyax.spaincentral-01.azurewebsites.net/

jobs:
  # ======================================================
  # JOB 1 — BUILD + ODC + UNIT TESTS + PUBLISH ARTIFACT
  # ======================================================
  build_and_prechecks:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Restore dependencies
        run: dotnet restore

      # ---- OWASP DEPENDENCY CHECK ----
      - name: Cache Dependency-Check data
        uses: actions/cache@v4
        with:
          path: ~/.dependency-check
          key: ${{ runner.os }}-dependency-check
          restore-keys: |
            ${{ runner.os }}-dependency-check

      - name: Run OWASP Dependency-Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: "bp"
          path: "."
          format: "HTML"
          out: "dependency-check-report"

      - name: Upload Dependency-Check report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: dependency-check-report

      # ---- BUILD ----
      - name: Build solution
        run: dotnet build -c Release --no-restore

      # ---- UNIT TESTS ----
      - name: Run Unit tests (excluding E2E)
        run: dotnet test -c Release --no-build --filter "TestCategory!=E2E"

      # ---- PUBLISH ARTIFACT ----
      - name: Publish Application
        run: dotnet publish BPCalculator/BPCalculator.csproj -c Release -o ./publish

      - name: Upload publish artifact
        uses: actions/upload-artifact@v4
        with:
          name: bpapp
          path: ./publish

  # ======================================================
  # JOB 2 — SONARCLOUD ANALYSIS (WITH QUALITY GATE WAIT)
  # ======================================================
  sonarcloud_analysis:
    name: SonarCloud Analysis
    runs-on: windows-latest
    needs: build_and_prechecks
    timeout-minutes: 20
    permissions:
      contents: read
      pull-requests: read
    env:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'microsoft'

      - name: Install SonarScanner for .NET
        shell: powershell
        run: |
          dotnet tool install --global dotnet-sonarscanner
          echo "$env:USERPROFILE\.dotnet\tools" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: SonarCloud - Begin analysis (wait for Quality Gate)
        shell: powershell
        run: |
          dotnet-sonarscanner begin `
            /k:"AbdulQader496_bp" `
            /o:"abdulqader496" `
            /d:sonar.host.url="https://sonarcloud.io" `
            /d:sonar.token="$env:SONAR_TOKEN" `
            /d:sonar.qualitygate.wait=true `
            /d:sonar.cs.opencover.reportsPaths="TestResults/**/coverage.opencover.xml" `
            /d:sonar.exclusions="**/bin/**,**/obj/**,**/*.dll,**/*.json,**/*.g.cs,**/*.cshtml,**/wwwroot/**,.github/workflows/**,k6Test/**" `
            /d:sonar.coverage.exclusions="**/Program.cs,**/Startup.cs,**/*.cshtml.cs,**/Pages/**/*,**/*Model.cs,k6Test/**"

      - name: Restore dependencies
        shell: powershell
        run: dotnet restore

      - name: Build solution
        shell: powershell
        run: dotnet build BPCalculator.sln --configuration Debug --no-restore

      - name: Test with OpenCover coverage
        shell: powershell
        run: |
          dotnet test TestProject1/TestProject.csproj `
            --no-build `
            --collect:"XPlat Code Coverage" `
            --results-directory "TestResults" `
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover

      - name: SonarCloud - End analysis
        shell: powershell
        run: dotnet-sonarscanner end /d:sonar.token="$env:SONAR_TOKEN"

  # ======================================================
  # JOB 3 — LOCAL SELENIUM + BDD TESTS (WINDOWS)
  # ======================================================
  local_selenium_bdd_tests:
    runs-on: windows-latest
    needs:
      - build_and_prechecks
      - sonarcloud_analysis
    permissions:
      contents: read

    steps:
      - name: Checkout Main Repo (.NET App)
        uses: actions/checkout@v4

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      # ==== BUILD + START LOCAL WEBSITE ====
      - name: Restore Website
        run: dotnet restore ./BPCalculator/BPCalculator.csproj

      - name: Build Website
        run: dotnet build ./BPCalculator/BPCalculator.csproj --configuration Release

      - name: Publish Website
        shell: pwsh
        run: |
          cd BPCalculator
          dotnet publish -c Release -o published

      - name: Start Local Website
        shell: pwsh
        run: |
          Write-Host "Starting Website on http://localhost:5000"
          Start-Process -FilePath "./BPCalculator/published/BPCalculator.exe"
          Start-Sleep -Seconds 30

      - name: Verify Website Running
        shell: pwsh
        run: |
          $response = Invoke-WebRequest -Uri "http://localhost:5000" -UseBasicParsing
          Write-Host "API is running with status code: $($response.StatusCode)"

      # ==== INSTALL CHROME ====
      - name: Install Google Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: latest

      - name: Check Chrome Version
        shell: pwsh
        run: chrome --version

      # ==== INSTALL CHROMEDRIVER ====
      - name: Install ChromeDriver
        uses: nanasess/setup-chromedriver@v2

      - name: Check ChromeDriver Version
        shell: pwsh
        run: chromedriver --version

      # ==== INSTALL JAVA FOR SELENIUM & BDD ====
      - name: Setup Java 21
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '21'

      # ==== MAVEN CACHE (AFTER JAVA SETUP, BEFORE MVN RUN) ====
      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      # ==== RUN SELENIUM TESTS ====
      - name: Clone Selenium Repo
        uses: actions/checkout@v4
        with:
          repository: AbdulQader496/bpTestSelenium
          path: selenium-tests

      - name: Run Selenium Tests
        shell: pwsh
        working-directory: ./selenium-tests
        run: mvn test

      # ==== RUN BDD TESTS ====
      - name: Clone BDD Repo
        uses: actions/checkout@v4
        with:
          repository: AbdulQader496/bpTestBDD
          path: bdd-tests

      - name: Run BDD Tests
        shell: pwsh
        working-directory: ./bdd-tests
        run: mvn test

  # ======================================================
  # JOB 4 — DEPLOY TO STAGING SLOT (DEV & MASTER)
  # ======================================================
  deploy_staging:
    needs:
      - build_and_prechecks
      - local_selenium_bdd_tests
      - sonarcloud_analysis
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    if: github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/master'
    environment: staging

    steps:
      - name: Download publish artifact
        uses: actions/download-artifact@v4
        with:
          name: bpapp
          path: ./publish

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy to Staging Slot
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.APP_NAME }}
          slot-name: ${{ env.STAGING_SLOT_NAME }}
          package: ./publish

  # ======================================================
  # JOB 5 — STAGING SECURITY & PERFORMANCE TESTS (ZAP + k6)
  # ======================================================
  staging_security_tests:
    needs: deploy_staging
    runs-on: ubuntu-latest
    permissions:
      contents: read
    if: github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/master'

    steps:
      - name: Prepare ZAP report directory
        run: mkdir -p zap-report

      - name: Pull ZAP Docker image
        run: docker pull zaproxy/zap-weekly

      # ---- INSTALL k6 ----
      - name: Install k6
        run: |
          sudo apt-get update
          sudo apt-get install -y gnupg ca-certificates
          curl https://dl.k6.io/key.gpg | sudo gpg --yes --dearmor -o /usr/share/keyrings/k6-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install -y k6

      # ---- k6 PERFORMANCE TEST (STAGING) ----
      - name: Run k6 Performance Test (Staging)
        env:
          BASE_URL: ${{ env.STAGING_URL }}
        run: |
          echo "Running k6 against STAGING: $BASE_URL"
          k6 run k6Test/performance.js --out json=k6-staging.json | tee k6-staging.txt

      - name: Upload k6 Staging Report
        uses: actions/upload-artifact@v4
        with:
          name: k6-staging-performance-report
          path: |
            k6-staging.txt
            k6-staging.json

      # ---- ZAP BASELINE SCAN ----
      - name: ZAP Baseline Scan vs Staging URL
        env:
          TARGET_URL: ${{ env.STAGING_URL }}
        run: |
          docker run \
            -v ${{ github.workspace }}/zap-report:/zap/wrk \
            --user root \
            zaproxy/zap-weekly \
            zap-baseline.py \
            -t "$TARGET_URL" \
            -I \
            -r zapreport.html

      - name: Upload ZAP Report
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: zap-report

  # ======================================================
  # JOB 6 — SLOT SWAP TO PROD (ONLY ON MASTER + MANUAL APPROVAL) + k6 PROD
  # ======================================================
  swap_staging_to_prod:
    needs:
      - deploy_staging
      - staging_security_tests
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    if: github.ref == 'refs/heads/master'
    environment:
      name: prod
      url: ${{ env.PROD_URL }}

    steps:
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Swap staging → production
        run: |
          az webapp deployment slot swap \
            --name ${{ env.APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --slot ${{ env.STAGING_SLOT_NAME }} \
            --target-slot production

      # ---- INSTALL k6 FOR PROD TEST ----
      - name: Install k6
        run: |
          sudo apt-get update
          sudo apt-get install -y gnupg ca-certificates
          curl https://dl.k6.io/key.gpg | sudo gpg --yes --dearmor -o /usr/share/keyrings/k6-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install -y k6

      # ---- k6 PERFORMANCE TEST (PRODUCTION) ----
      - name: Run k6 Performance Test (Production)
        env:
          BASE_URL: ${{ env.PROD_URL }}
        run: |
          echo "Running k6 against PRODUCTION: $BASE_URL"
          k6 run k6Test/performance.js --out json=k6-prod.json | tee k6-prod.txt

      - name: Upload k6 Production Report
        uses: actions/upload-artifact@v4
        with:
          name: k6-production-performance-report
          path: |
            k6-prod.txt
            k6-prod.json